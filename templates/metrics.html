{% extends 'base.html' %}

{% block head %}
<style>
    .metrics-page {
        padding: 4rem 1.5rem;
        max-width: 1100px;
        margin: 0 auto;
    }

    .model-block {
        margin-bottom: 3rem;
    }

    .model-block-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-glass);
    }

    .model-badge {
        padding: 0.3rem 0.9rem;
        border-radius: 20px;
        font-size: 0.78rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
        color: white;
    }

    .metrics-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="metrics-page">

    <div class="section-header">
        <p class="section-eyebrow">Model Evaluation</p>
        <h1 class="section-title">Performance Metrics</h1>
        <p class="section-sub">Evaluation scores for all 4 trained models computed on the full synthetic dataset.</p>
    </div>

    <div id="loading" class="text-center">
        <div class="spinner"></div>
        <p style="color:var(--text-muted);">Evaluating models...</p>
    </div>

    <div id="metrics-container" class="hidden"></div>
    <div id="error-msg" class="hidden text-center mt-4" style="color:var(--danger);"></div>

</div>
{% endblock %}

{% block scripts %}
<script>
    const modelIcons = {
        linear_regression: 'fa-chart-line',
        decision_tree: 'fa-sitemap',
        knn: 'fa-circle-nodes',
        kmeans: 'fa-object-group',
    };

    const metricLabels = {
        mae: 'MAE', rmse: 'RMSE', r2: 'RÂ² Score',
        accuracy: 'Accuracy', f1: 'F1 Score',
        precision: 'Precision', recall: 'Recall',
        silhouette_score: 'Silhouette', inertia: 'Inertia', n_clusters: 'Clusters'
    };

    async function loadMetrics() {
        try {
            const res = await fetch('/api/metrics');
            const data = await res.json();

            if (data.status === 'error') throw new Error(data.message);

            document.getElementById('loading').classList.add('hidden');
            const container = document.getElementById('metrics-container');
            container.classList.remove('hidden');

            Object.entries(data.metrics).forEach(([key, model]) => {
                const metricKeys = Object.keys(model).filter(k => !['name', 'task'].includes(k));

                const cardsHTML = metricKeys.map(mk => `
        <div class="glass-card metric-card">
          <div class="m-label">${metricLabels[mk] || mk}</div>
          <div class="m-value">${typeof model[mk] === 'number' && !Number.isInteger(model[mk])
                        ? model[mk].toFixed(4) : model[mk]}</div>
        </div>
      `).join('');

                const block = document.createElement('div');
                block.className = 'model-block glass-card';
                block.innerHTML = `
        <div class="model-block-header">
          <i class="fa-solid ${modelIcons[key] || 'fa-robot'}" style="color:var(--primary-start);font-size:1.4rem;"></i>
          <div>
            <h2 style="font-size:1.1rem;font-weight:700;">${model.name}</h2>
            <p style="font-size:0.82rem;color:var(--text-muted);">${model.task}</p>
          </div>
          <span class="model-badge" style="margin-left:auto;">${key.replace('_', ' ').toUpperCase()}</span>
        </div>
        <div class="metrics-cards">${cardsHTML}</div>
      `;
                container.appendChild(block);
            });

        } catch (err) {
            document.getElementById('loading').classList.add('hidden');
            const errEl = document.getElementById('error-msg');
            errEl.classList.remove('hidden');
            errEl.textContent = 'Could not load metrics: ' + err.message;
        }
    }

    loadMetrics();
</script>
{% endblock %}