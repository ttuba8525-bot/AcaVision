{% extends 'base.html' %}

{% block head %}
<style>
    .viz-page {
        padding: 4rem 1.5rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 3rem;
    }

    .chart-title {
        font-size: 1rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--text-muted);
    }

    @media(max-width:768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="viz-page">
    <div class="section-header">
        <p class="section-eyebrow">Data Insights</p>
        <h1 class="section-title">Visualisation Dashboard</h1>
        <p class="section-sub">Explore student clusters, performance distributions, and risk patterns across 1200+
            records.</p>
    </div>

    <div id="loading" class="text-center">
        <div class="spinner"></div>
        <p style="color:var(--text-muted);">Loading dataset...</p>
    </div>

    <div id="charts-container" class="hidden">
        <div class="charts-grid">

            <!-- Scatter: Risk Clusters -->
            <div class="chart-wrap">
                <p class="chart-title"><i class="fa-solid fa-circle-nodes" style="color:var(--primary-start)"></i>
                    Academic Risk Clusters</p>
                <div id="scatter-chart" style="height:320px;"></div>
            </div>

            <!-- Bar: Performance Distribution -->
            <div class="chart-wrap">
                <p class="chart-title"><i class="fa-solid fa-chart-bar" style="color:var(--primary-end)"></i>
                    Performance Category Distribution</p>
                <canvas id="bar-chart" height="320"></canvas>
            </div>

            <!-- Pie: Pass / Fail -->
            <div class="chart-wrap">
                <p class="chart-title"><i class="fa-solid fa-chart-pie" style="color:var(--success)"></i> Pass vs Fail
                    Ratio</p>
                <canvas id="pie-chart" height="320"></canvas>
            </div>

            <!-- Scatter: Study Hours vs Score (Plotly) -->
            <div class="chart-wrap">
                <p class="chart-title"><i class="fa-solid fa-graduation-cap" style="color:var(--warning)"></i> Risk
                    Groups: Attendance vs Study Hours</p>
                <div id="cluster-map" style="height:320px;"></div>
            </div>

        </div>
    </div>

    <div id="error-msg" class="hidden text-center mt-4" style="color:var(--danger);"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const clusterColors = {
        'High Risk': '#ff4d6d',
        'Medium Risk': '#ffb830',
        'Low Risk': '#00e096',
    };

    async function loadViz() {
        try {
            const res = await fetch('/api/visualize');
            const data = await res.json();

            if (data.error) throw new Error(data.error);

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('charts-container').classList.remove('hidden');

            // ── Plotly Scatter: Risk Clusters ──────────────────
            const groups = {};
            data.clusters.labels.forEach((label, i) => {
                if (!groups[label]) groups[label] = { x: [], y: [] };
                groups[label].x.push(data.clusters.study_hours[i]);
                groups[label].y.push(data.clusters.attendance[i]);
            });

            const scatterTraces = Object.entries(groups).map(([label, pts]) => ({
                type: 'scatter', mode: 'markers',
                name: label, x: pts.x, y: pts.y,
                marker: { color: clusterColors[label] || '#888', size: 5, opacity: 0.7 }
            }));

            Plotly.newPlot('scatter-chart', scatterTraces, {
                paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                font: { color: '#c8d7ff', size: 11 },
                margin: { l: 40, r: 10, t: 10, b: 40 },
                xaxis: { title: 'Study Hours/day', gridcolor: 'rgba(255,255,255,0.06)', zerolinecolor: 'rgba(255,255,255,0.1)' },
                yaxis: { title: 'Attendance (%)', gridcolor: 'rgba(255,255,255,0.06)', zerolinecolor: 'rgba(255,255,255,0.1)' },
                legend: { bgcolor: 'transparent' },
                showlegend: true
            }, { responsive: true, displayModeBar: false });

            // ── Plotly: Cluster Map same data different view ─
            Plotly.newPlot('cluster-map', scatterTraces, {
                paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                font: { color: '#c8d7ff', size: 11 },
                margin: { l: 40, r: 10, t: 10, b: 40 },
                xaxis: { title: 'Study Hours/day', gridcolor: 'rgba(255,255,255,0.06)' },
                yaxis: { title: 'Attendance (%)', gridcolor: 'rgba(255,255,255,0.06)' },
                legend: { bgcolor: 'transparent' }, showlegend: false
            }, { responsive: true, displayModeBar: false });

            // ── Chart.js Bar: Performance ──────────────────────
            const perfLabels = Object.keys(data.performance);
            const perfVals = Object.values(data.performance);
            new Chart(document.getElementById('bar-chart'), {
                type: 'bar',
                data: {
                    labels: perfLabels,
                    datasets: [{
                        label: 'Students',
                        data: perfVals,
                        backgroundColor: ['rgba(79,140,255,0.7)', 'rgba(166,108,255,0.7)', 'rgba(0,224,150,0.7)', 'rgba(255,184,48,0.7)'],
                        borderRadius: 8, borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#c8d7ff' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { ticks: { color: '#c8d7ff' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });

            // ── Chart.js Pie: Pass / Fail ──────────────────────
            const pfLabels = Object.keys(data.pass_fail);
            const pfVals = Object.values(data.pass_fail);
            new Chart(document.getElementById('pie-chart'), {
                type: 'doughnut',
                data: {
                    labels: pfLabels,
                    datasets: [{
                        data: pfVals,
                        backgroundColor: ['rgba(0,224,150,0.8)', 'rgba(255,77,109,0.8)'],
                        borderColor: ['#00e096', '#ff4d6d'], borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#c8d7ff' } }
                    }
                }
            });

        } catch (err) {
            document.getElementById('loading').classList.add('hidden');
            const errEl = document.getElementById('error-msg');
            errEl.classList.remove('hidden');
            errEl.textContent = 'Could not load visualisation data: ' + err.message;
        }
    }

    loadViz();
</script>
{% endblock %}