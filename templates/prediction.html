{% extends 'base.html' %}

{% block head %}
<style>
    .predict-page {
        padding: 4rem 1.5rem;
        max-width: 1100px;
        margin: 0 auto;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    .form-submit {
        margin-top: 2rem;
        text-align: center;
    }

    .results-section {
        animation: fadeIn 0.5s ease;
    }

    @media(max-width:768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="predict-page">

    <!-- Page Header -->
    <div class="section-header">
        <p class="section-eyebrow">ML Prediction Engine</p>
        <h1 class="section-title">Predict Your Academic Performance</h1>
        <p class="section-sub">Fill in your details and let our 4 AI models analyse your academic profile instantly.</p>
    </div>

    <!-- Prediction Form -->
    <div class="glass-card mb-4" id="predict-form-card">
        <form id="predict-form">
            <div class="form-grid">

                <!-- Attendance -->
                <div class="form-group">
                    <label class="form-label">
                        Attendance (%) <span class="range-value" id="attendance-val">75</span>
                    </label>
                    <input type="range" id="attendance" name="attendance" min="0" max="100" value="75"
                        oninput="document.getElementById('attendance-val').textContent=this.value">
                </div>

                <!-- Study Hours -->
                <div class="form-group">
                    <label class="form-label">
                        Study Hours / Day <span class="range-value" id="study-val">4</span>
                    </label>
                    <input type="range" id="study_hours" name="study_hours" min="0" max="12" step="0.5" value="4"
                        oninput="document.getElementById('study-val').textContent=this.value">
                </div>

                <!-- Assignment Score -->
                <div class="form-group">
                    <label class="form-label">
                        Assignment Score <span class="range-value" id="assign-val">70</span>
                    </label>
                    <input type="range" id="assignment_score" name="assignment_score" min="0" max="100" value="70"
                        oninput="document.getElementById('assign-val').textContent=this.value">
                </div>

                <!-- Previous GPA -->
                <div class="form-group">
                    <label class="form-label">
                        Previous GPA <span class="range-value" id="gpa-val">6.5</span>
                    </label>
                    <input type="range" id="previous_gpa" name="previous_gpa" min="0" max="10" step="0.1" value="6.5"
                        oninput="document.getElementById('gpa-val').textContent=this.value">
                </div>

                <!-- Internet Usage -->
                <div class="form-group">
                    <label class="form-label">
                        Internet Usage hrs/day <span class="range-value" id="internet-val">4</span>
                    </label>
                    <input type="range" id="internet_usage" name="internet_usage" min="0" max="12" step="0.5" value="4"
                        oninput="document.getElementById('internet-val').textContent=this.value">
                </div>

                <!-- Sleep Hours -->
                <div class="form-group">
                    <label class="form-label">
                        Sleep Hours / Night <span class="range-value" id="sleep-val">7</span>
                    </label>
                    <input type="range" id="sleep_hours" name="sleep_hours" min="3" max="10" step="0.5" value="7"
                        oninput="document.getElementById('sleep-val').textContent=this.value">
                </div>

                <!-- Family Support Index -->
                <div class="form-group">
                    <label class="form-label">
                        Family Support Index <span class="range-value" id="family-val">5</span>
                    </label>
                    <input type="range" id="family_support" name="family_support" min="1" max="10" value="5"
                        oninput="document.getElementById('family-val').textContent=this.value">
                </div>

                <!-- Participation Level -->
                <div class="form-group">
                    <label class="form-label">Participation Level</label>
                    <select id="participation_level" name="participation_level" class="form-control">
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>

                <!-- Extra Curricular -->
                <div class="form-group">
                    <label class="form-label">Extra-Curricular Activities</label>
                    <select id="extra_curricular" name="extra_curricular" class="form-control">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>

            </div><!-- /form-grid -->

            <div class="form-submit">
                <button type="submit" class="btn-primary magnetic" id="predict-btn" style="min-width:220px;">
                    <i class="fa-solid fa-brain"></i> Analyse My Profile
                </button>
            </div>
        </form>
    </div>

    <!-- Results Section (hidden until prediction) -->
    <div id="results-section" class="hidden results-section">

        <div class="section-header mb-3">
            <p class="section-eyebrow">Your Results</p>
            <h2 class="section-title" style="font-size:1.8rem;">Academic Profile Analysis</h2>
        </div>

        <!-- Score Cards -->
        <div class="result-grid mb-4">
            <div class="result-card primary glass-card">
                <div class="label">Predicted Score</div>
                <div class="value" id="res-score">—</div>
                <div style="font-size:0.8rem;color:var(--text-muted);margin-top:0.25rem;">out of 100</div>
            </div>
            <div class="result-card glass-card" id="res-passfail-card">
                <div class="label">Pass / Fail</div>
                <div class="value" id="res-passfail">—</div>
            </div>
            <div class="result-card glass-card" id="res-perf-card">
                <div class="label">Performance</div>
                <div class="value" id="res-performance">—</div>
            </div>
            <div class="result-card glass-card" id="res-risk-card">
                <div class="label">Risk Level</div>
                <div class="value" id="res-risk">—</div>
            </div>
        </div>

        <!-- Advisory -->
        <div class="glass-card">
            <h3 style="margin-bottom:1.2rem; font-size:1.1rem;">
                <i class="fa-solid fa-lightbulb" style="color:var(--warning);"></i>
                &nbsp;Personalised Advisory
            </h3>
            <ul class="advisory-list" id="advisory-list"></ul>
        </div>

        <!-- Predict Again -->
        <div class="text-center mt-4">
            <button class="btn-outline" onclick="resetForm()">
                <i class="fa-solid fa-rotate-left"></i> Predict Again
            </button>
        </div>

    </div><!-- /results-section -->
</div>
{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById('predict-form');
    const resultsSection = document.getElementById('results-section');
    const predictBtn = document.getElementById('predict-btn');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        predictBtn.disabled = true;
        predictBtn.innerHTML = '<span class="spinner" style="width:20px;height:20px;border-width:2px;margin:0;display:inline-block;vertical-align:middle;"></span> Analysing...';

        const payload = {
            attendance: document.getElementById('attendance').value,
            study_hours: document.getElementById('study_hours').value,
            assignment_score: document.getElementById('assignment_score').value,
            previous_gpa: document.getElementById('previous_gpa').value,
            participation_level: document.getElementById('participation_level').value,
            internet_usage: document.getElementById('internet_usage').value,
            sleep_hours: document.getElementById('sleep_hours').value,
            family_support: document.getElementById('family_support').value,
            extra_curricular: document.getElementById('extra_curricular').value,
        };

        try {
            const res = await fetch('/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                showResults(data);
            }
        } catch (err) {
            alert('Network error. Is the server running?');
        } finally {
            predictBtn.disabled = false;
            predictBtn.innerHTML = '<i class="fa-solid fa-brain"></i> Analyse My Profile';
        }
    });

    function showResults(data) {
        document.getElementById('res-score').textContent = data.exam_score;

        const pf = data.pass_fail;
        document.getElementById('res-passfail').textContent = pf;
        document.getElementById('res-passfail-card').className = 'result-card glass-card ' + (pf === 'Pass' ? 'success' : 'danger');

        document.getElementById('res-performance').textContent = data.performance;
        const riskColorMap = { 'High Risk': 'danger', 'Medium Risk': 'warning', 'Low Risk': 'success' };
        document.getElementById('res-risk').textContent = data.risk_cluster;
        document.getElementById('res-risk-card').className = 'result-card glass-card ' + (riskColorMap[data.risk_cluster] || '');

        const list = document.getElementById('advisory-list');
        list.innerHTML = data.advisory.map(tip => `<li>${tip}</li>`).join('');

        document.getElementById('predict-form-card').classList.add('hidden');
        resultsSection.classList.remove('hidden');
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function resetForm() {
        resultsSection.classList.add('hidden');
        document.getElementById('predict-form-card').classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>
{% endblock %}